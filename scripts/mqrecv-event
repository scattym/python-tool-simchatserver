#!/usr/bin/env python
import json

import pika
import psycopg2

# connection = pika.BlockingConnection(pika.ConnectionParameters(host='localhost'))
# channel = connection.channel()
# sql = """
#  INSERT INTO event_eventlog (device_id, timestamp, event_description, event_type, log_time, acknowledged_flag)
#   VALUES (%s, %s, %s, %s, %s, %s)
# """
#
# try:
#     conn = psycopg2.connect("dbname='geotool' user='django' host='localhost' password='tiapw4gd2u'")
# except:
#     print("I am unable to connect to the database")
# cur = conn.cursor()
#
# imei_map = {}
#
# def callback(ch, method, properties, body):
#     print(" [x] Received %r" % body)
#     data = json.loads(body.decode())
#     print("Imei is %s" % data["imei"])
#     if imei_map.get(data["imei"]):
#         device_id = imei_map.get(data["imei"])
#     else:
#         cur.execute("""select id from device_device where imei=%s""", (data["imei"],))
#         rows = cur.fetchall()
#         device_id = rows[0][0]
#         imei_map[data["imei"]] = device_id
#     # keys = data.keys()
#     # values = [data[column] for column in data.remove("log_time")]
#     result = cur.execute(
#         sql, (
#             device_id, data["timestamp"], data["event_description"], data["event_type"], data["log_time"],
#             False
#         )
#     )
#     print(result)
#     updated_rows = cur.rowcount
#     print(updated_rows)
#     result = conn.commit()
#     print(result)
#
#
# channel.basic_consume(callback,
#                       queue='event_log',
#                       no_ack=True)
#
# channel.queue_declare(queue='event_log')
#
# print(' [*] Waiting for messages. To exit press CTRL+C')
# channel.start_consuming()

import asyncio
import aio_pika
import json
import datetime
from sim_chat_lib.geotool_db_api.device_api import get_device_id
from sim_chat_lib.geotool_db_api.event_api import get_insert_eventlog_coroutine


async def main(loop):
    connection = await aio_pika.connect_robust("amqp://guest:guest@127.0.0.1/", loop=loop)

    queue_name = "event_log"

    # Creating channel
    channel = await connection.channel()    # type: aio_pika.Channel

    # Declaring queue
    queue = await channel.declare_queue(queue_name)   # type: aio_pika.Queue
    imei_map = {}

    async for message in queue:
        with message.process():
            print(message.body)
            data = json.loads(message.body)
            if imei_map.get(data["imei"]):
                device_id = imei_map.get(data["imei"])
            else:
                device_id = await get_device_id(data["imei"])
                if device_id:
                    imei_map[data["imei"]] = device_id

            print("Device id is %s" % (device_id,))
            if '.' not in data["timestamp"]:
                data["timestamp"] = "{}.0".format(data["timestamp"])
            timestamp = datetime.datetime.strptime(data["timestamp"], "%Y-%m-%d %H:%M:%S.%f")
            if "." not in data["log_time"]:
                data["log_time"] = "{}.0".format(data["log_time"])
            log_time = datetime.datetime.strptime(data["log_time"], "%Y-%m-%d %H:%M:%S.%f")
            if device_id:
                loop.create_task(get_insert_eventlog_coroutine(
                    device_id, timestamp, data["event_description"], str(data["event_type"]), log_time,
                ))

            if queue.name in message.body.decode():
                break


if __name__ == "__main__":
    loop = asyncio.get_event_loop()
    loop.run_until_complete(main(loop))
    loop.close()